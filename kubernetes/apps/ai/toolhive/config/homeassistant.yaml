---
apiVersion: toolhive.stacklok.dev/v1alpha1
kind: MCPServer
metadata:
  name: &name homeassistant
  namespace: ai
spec:
  image: ghcr.io/sparfenyuk/mcp-proxy:latest
  transport: streamable-http
  groupRef: mcp-tools
  args:
    - https://homeassistant.${SECRET_DOMAIN}/api/mcp
    - --transport=streamablehttp
    - --stateless
    - --no-verify-ssl
  secrets:
    - name: toolhive-secrets
      key: HOMEASSISTANT_API_TOKEN
      targetEnvName: API_ACCESS_TOKEN
  toolConfigRef:
    name: *name
  podTemplateSpec:
    spec:
      containers:
        - name: mcp
          # ToolHive expects stdio to the container; mcp-proxy client mode exits after each session. Restart immediately (no sleep) to minimize 502 window.
          command:
            - /bin/sh
            - -c
            - |
              while true; do
                mcp-proxy 'https://homeassistant.${SECRET_DOMAIN}/api/mcp' --transport=streamablehttp --stateless --no-verify-ssl || true
              done
          resources:
            limits:
              cpu: "500m"
              memory: "110Mi"
            requests:
              cpu: "10m"
              memory: "110Mi"
  resources:
    limits:
      cpu: 200m
      memory: 100Mi
    requests:
      cpu: 10m
      memory: 100Mi
---
apiVersion: toolhive.stacklok.dev/v1alpha1
kind: MCPToolConfig
metadata:
  name: homeassistant
  namespace: ai
spec: {}
