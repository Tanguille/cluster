---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/monitoring.coreos.com/alertmanagerconfig_v1alpha1.json
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: alertmanager
spec:
  route:
    groupBy: ["alertname", "job"]
    groupInterval: 10m
    groupWait: 1m
    receiver: discord
    repeatInterval: 12h
    routes:
      - receiver: "null"
        matchers:
          - name: alertname
            value: InfoInhibitor
            matchType: =
      - receiver: discord
        matchers:
          - name: severity
            value: critical
            matchType: =
  inhibitRules:
    - equal: ["alertname", "namespace"]
      sourceMatch:
        - name: severity
          value: critical
          matchType: =
      targetMatch:
        - name: severity
          value: warning
          matchType: =
  receivers:
    - name: "null"
    - name: discord
      discordConfigs:
        - apiURL:
            name: alertmanager-secret
            key: DISCORD_WEBHOOK_URL
          title: |-
            {{- if eq .Status "firing" }}üî• FIRING{{- else }}‚úÖ RESOLVED{{- end }} - {{ .GroupLabels.alertname | title }}
          message: |-
            {
              "embeds": [
                {{- range $i, $alert := .Alerts }}
                {{- if $i }},{{- end }}
                {
                  "title": "{{ $alert.Labels.alertname }}",
                  "description": "{{- if ne $alert.Annotations.description "" }}{{ $alert.Annotations.description }}{{- else if ne $alert.Annotations.summary "" }}{{ $alert.Annotations.summary }}{{- else if ne $alert.Annotations.message "" }}{{ $alert.Annotations.message }}{{- else }}Alert triggered{{- end }}",
                  "color": {{- if eq $alert.Status "firing" }}{{- if eq $alert.Labels.severity "critical" }}15158332{{- else if eq $alert.Labels.severity "warning" }}16776960{{- else }}3447003{{- end }}{{- else }}3066993{{- end }},
                  "fields": [
                    {
                      "name": "üéØ Status",
                      "value": "{{ $alert.Status | upper }}",
                      "inline": true
                    },
                    {
                      "name": "‚ö†Ô∏è Severity",
                      "value": "{{ $alert.Labels.severity | default "unknown" | upper }}",
                      "inline": true
                    },
                    {
                      "name": "üè∑Ô∏è Job",
                      "value": "{{ $alert.Labels.job | default "unknown" }}",
                      "inline": true
                    }
                    {{- if $alert.Labels.instance }},
                    {
                      "name": "üñ•Ô∏è Instance",
                      "value": "`{{ $alert.Labels.instance }}`",
                      "inline": true
                    }
                    {{- end }}
                    {{- if $alert.Labels.namespace }},
                    {
                      "name": "üì¶ Namespace",
                      "value": "`{{ $alert.Labels.namespace }}`",
                      "inline": true
                    }
                    {{- end }}
                    {{- if $alert.Labels.pod }},
                    {
                      "name": "üê≥ Pod",
                      "value": "`{{ $alert.Labels.pod }}`",
                      "inline": true
                    }
                    {{- end }}
                  ],
                  "timestamp": "{{ $alert.StartsAt.Format "2006-01-02T15:04:05Z07:00" }}",
                  "footer": {
                    "text": "Prometheus Alert ‚Ä¢ {{ $alert.Labels.prometheus | default "cluster" }}",
                    "icon_url": "https://prometheus.io/assets/prometheus_logo-cb55bb5c346.png"
                  }
                  {{- if $alert.GeneratorURL }},
                  "url": "{{ $alert.GeneratorURL }}"
                  {{- end }}
                }
                {{- end }}
              ]
            }
