---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/monitoring.coreos.com/alertmanagerconfig_v1alpha1.json
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: alertmanager
spec:
  route:
    groupBy: ["alertname", "job"]
    groupInterval: 10m
    groupWait: 1m
    receiver: discord
    repeatInterval: 12h
    routes:
      - receiver: "null"
        matchers:
          - name: alertname
            value: InfoInhibitor
            matchType: =
      - receiver: discord
        matchers:
          - name: severity
            value: critical
            matchType: =
  inhibitRules:
    - equal: ["alertname", "namespace"]
      sourceMatch:
        - name: severity
          value: critical
          matchType: =
      targetMatch:
        - name: severity
          value: warning
          matchType: =
  receivers:
    - name: "null"
    - name: discord
      discordConfigs:
        - apiURL:
            name: alertmanager-secret
            key: DISCORD_WEBHOOK_URL
          title: |-
            {{- if eq .Status "firing" }}ðŸ”¥ **FIRING**{{- else }}âœ… **RESOLVED**{{- end }} - {{ .GroupLabels.alertname }}
          message: |-
            {{- range .Alerts }}
            ## {{ .Labels.alertname }}

            **Status:** {{ .Status | upper }}
            **Severity:** {{ .Labels.severity | default "unknown" | upper }}

            {{- if ne .Annotations.description "" }}
            **Description:** {{ .Annotations.description }}
            {{- else if ne .Annotations.summary "" }}
            **Summary:** {{ .Annotations.summary }}
            {{- else if ne .Annotations.message "" }}
            **Message:** {{ .Annotations.message }}
            {{- else }}
            Alert has been triggered
            {{- end }}

            **Details:**
            {{- if .Labels.job }}
            â€¢ **Job:** `{{ .Labels.job }}`
            {{- end }}
            {{- if .Labels.instance }}
            â€¢ **Instance:** `{{ .Labels.instance }}`
            {{- end }}
            {{- if .Labels.namespace }}
            â€¢ **Namespace:** `{{ .Labels.namespace }}`
            {{- end }}
            {{- if .Labels.pod }}
            â€¢ **Pod:** `{{ .Labels.pod }}`
            {{- end }}
            {{- if .Labels.prometheus }}
            â€¢ **Prometheus:** `{{ .Labels.prometheus }}`
            {{- end }}

            **Started:** <t:{{ .StartsAt.Unix }}:F>
            {{- if .GeneratorURL }}

            [ðŸ”— View in Prometheus]({{ .GeneratorURL }})
            {{- end }}

            ---
            {{- end }}
