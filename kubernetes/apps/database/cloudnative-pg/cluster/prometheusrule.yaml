---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cloudnative-pg-rules
  labels:
    prometheus: k8s
    role: alert-rules
spec:
  groups:
    - name: cnpg_metric_aliases
      interval: 30s
      rules:
        # Map CNPG metrics to standard PostgreSQL metric names for dashboard compatibility
        # All rules set job="pg_exporter" while preserving instance and datname labels
        # Using label_replace with job as source to replace existing job label
        - record: pg_stat_database_blks_hit
          expr: label_replace(cnpg_pg_stat_database_blks_hit, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_blks_read
          expr: label_replace(cnpg_pg_stat_database_blks_read, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_tup_returned
          expr: label_replace(cnpg_pg_stat_database_tup_returned, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_tup_fetched
          expr: label_replace(cnpg_pg_stat_database_tup_fetched, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_tup_inserted
          expr: label_replace(cnpg_pg_stat_database_tup_inserted, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_tup_updated
          expr: label_replace(cnpg_pg_stat_database_tup_updated, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_tup_deleted
          expr: label_replace(cnpg_pg_stat_database_tup_deleted, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_conflicts
          expr: label_replace(cnpg_pg_stat_database_conflicts, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_deadlocks
          expr: label_replace(cnpg_pg_stat_database_deadlocks, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_xact_commit
          expr: label_replace(cnpg_pg_stat_database_xact_commit, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_xact_rollback
          expr: label_replace(cnpg_pg_stat_database_xact_rollback, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_temp_files
          expr: label_replace(cnpg_pg_stat_database_temp_files, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_temp_bytes
          expr: label_replace(cnpg_pg_stat_database_temp_bytes, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_blk_read_time
          expr: label_replace(cnpg_pg_stat_database_blk_read_time, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_database_blk_write_time
          expr: label_replace(cnpg_pg_stat_database_blk_write_time, "job", "pg_exporter", "job", ".*")
        - record: pg_database_size_bytes
          expr: label_replace(cnpg_pg_database_size_bytes, "job", "pg_exporter", "job", ".*")
        # Background writer stats
        - record: pg_stat_bgwriter_buffers_alloc
          expr: label_replace(cnpg_pg_stat_bgwriter_buffers_alloc, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_bgwriter_buffers_clean
          expr: label_replace(cnpg_pg_stat_bgwriter_buffers_clean, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_bgwriter_maxwritten_clean
          expr: label_replace(cnpg_pg_stat_bgwriter_maxwritten_clean, "job", "pg_exporter", "job", ".*")
        # Backends/connections - critical for dashboard variables
        - record: pg_stat_activity_count
          expr: label_replace(cnpg_backends_total, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_activity_max_tx_duration
          expr: label_replace(cnpg_backends_max_tx_duration_seconds, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_activity_waiting
          expr: label_replace(cnpg_backends_waiting_total, "job", "pg_exporter", "job", ".*")
        # PostgreSQL settings (filtered by setting name)
        - record: pg_settings_max_connections
          expr: label_replace(cnpg_pg_settings_setting{name="max_connections"}, "job", "pg_exporter", "job", ".*")
        - record: pg_settings_shared_buffers
          expr: label_replace(cnpg_pg_settings_setting{name="shared_buffers"}, "job", "pg_exporter", "job", ".*")
        - record: pg_settings_effective_cache_size
          expr: label_replace(cnpg_pg_settings_setting{name="effective_cache_size"}, "job", "pg_exporter", "job", ".*")
        - record: pg_settings_maintenance_work_mem
          expr: label_replace(cnpg_pg_settings_setting{name="maintenance_work_mem"}, "job", "pg_exporter", "job", ".*")
        - record: pg_settings_work_mem
          expr: label_replace(cnpg_pg_settings_setting{name="work_mem"}, "job", "pg_exporter", "job", ".*")
        - record: pg_settings_max_wal_size
          expr: label_replace(cnpg_pg_settings_setting{name="max_wal_size"}, "job", "pg_exporter", "job", ".*")
        - record: pg_settings_random_page_cost
          expr: label_replace(cnpg_pg_settings_setting{name="random_page_cost"}, "job", "pg_exporter", "job", ".*")
        - record: pg_settings_seq_page_cost
          expr: label_replace(cnpg_pg_settings_setting{name="seq_page_cost"}, "job", "pg_exporter", "job", ".*")
        - record: pg_settings_max_worker_processes
          expr: label_replace(cnpg_pg_settings_setting{name="max_worker_processes"}, "job", "pg_exporter", "job", ".*")
        - record: pg_settings_max_parallel_workers
          expr: label_replace(cnpg_pg_settings_setting{name="max_parallel_workers"}, "job", "pg_exporter", "job", ".*")
        # Checkpointer stats
        - record: pg_stat_checkpointer_buffers_written
          expr: label_replace(cnpg_pg_stat_checkpointer_buffers_written, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_checkpointer_checkpoints_timed
          expr: label_replace(cnpg_pg_stat_checkpointer_checkpoints_timed, "job", "pg_exporter", "job", ".*")
        - record: pg_stat_checkpointer_checkpoints_req
          expr: label_replace(cnpg_pg_stat_checkpointer_checkpoints_req, "job", "pg_exporter", "job", ".*")
        # Minimal exporter compatibility: provide pg_up with instance label for dashboards expecting postgres_exporter
        # Convert boolean to 1 and set job label
        - record: pg_up
          expr: label_replace((count by (instance) (cnpg_pg_stat_database_blks_read) > bool 0) * 1, "job", "pg_exporter", "instance", "(.*)")
    - name: cloudnative-pg.rules
      rules:
        - alert: LongRunningTransaction
          annotations:
            description: Pod {{ $labels.pod }} is taking more than 5 minutes (300 seconds) for a query.
            summary: A query is taking longer than 5 minutes.
          expr: |-
            cnpg_backends_max_tx_duration_seconds > 300
          for: 1m
          labels:
            severity: warning
        - alert: BackendsWaiting
          annotations:
            description: Pod {{ $labels.pod }} has been waiting for longer than 5 minutes
            summary: If a backend is waiting for longer than 5 minutes
          expr: |-
            cnpg_backends_waiting_total > 300
          for: 1m
          labels:
            severity: warning
        - alert: PGDatabase
          annotations:
            description: Over 150,000,000 transactions from frozen xid on pod {{ $labels.pod }}
            summary: Number of transactions from the frozen XID to the current one
          expr: |-
            cnpg_pg_database_xid_age > 150000000
          for: 1m
          labels:
            severity: warning
        - alert: PGReplication
          annotations:
            description: Standby is lagging behind by over 300 seconds (5 minutes)
            summary: The standby is lagging behind the primary
          expr: |-
            cnpg_pg_replication_lag > 300
          for: 1m
          labels:
            severity: warning
        - alert: LastFailedArchiveTime
          annotations:
            description: Archiving failed for {{ $labels.pod }}
            summary: Checks the last time archiving failed. Will be < 0 when it has not failed.
          expr: |-
            (cnpg_pg_stat_archiver_last_failed_time - cnpg_pg_stat_archiver_last_archived_time) > 1
          for: 1m
          labels:
            severity: warning
        - alert: DatabaseDeadlockConflicts
          annotations:
            description: There are over 10 deadlock conflicts in {{ $labels.pod }}
            summary: Checks the number of database conflicts
          expr: |-
            cnpg_pg_stat_database_deadlocks > 10
          for: 1m
          labels:
            severity: warning
