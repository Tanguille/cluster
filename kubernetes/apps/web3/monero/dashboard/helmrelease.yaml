---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dashboard
spec:
  chartRef:
    kind: OCIRepository
    name: app-template
  interval: 1h
  values:
    controllers:
      dashboard:
        strategy: RollingUpdate
        containers:
          web:
            image:
              repository: nginx
              tag: 1.29-alpine
            command:
              - sh
            args:
              - -c
              - |
                mkdir -p /tmp/nginx && \
                nginx -g 'daemon off;';
            ports:
              - name: web
                containerPort: 80
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities: { drop: ["ALL"] }
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 101
        runAsGroup: 101
        fsGroup: 101
        fsGroupChangePolicy: OnRootMismatch
    service:
      dashboard:
        type: ClusterIP
        ports:
          web:
            port: 80
            targetPort: web
    persistence:
      shared-api-data:
        existingClaim: p2pool-shared-api-data
        globalMounts:
          - path: /var/lib/p2pool/api
      dashboard-html:
        type: configMap
        name: "dashboard"
        globalMounts:
          - path: /usr/share/nginx/html/index.html
            subPath: dashboard.html
          - path: /usr/share/nginx/html/dashboard.css
            subPath: dashboard.css
          - path: /usr/share/nginx/html/dashboard.js
            subPath: dashboard.js
      nginx-config:
        type: configMap
        name: "dashboard-nginx-config"
        globalMounts:
          - path: /etc/nginx/nginx.conf
            subPath: nginx.conf
