---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dashboard
spec:
  chartRef:
    kind: OCIRepository
    name: app-template
  interval: 1h
  values:
    controllers:
      dashboard:
        strategy: RollingUpdate
        containers:
          web:
            image:
              repository: nginx
              tag: 1.29-alpine
            command:
              - sh
            args:
              - -c
              - |
                mkdir -p /tmp/nginx && \
                nginx -g 'daemon off;';
            ports:
              - name: web
                containerPort: 80
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities: { drop: ["ALL"] }
          dashboard-server:
            image:
              repository: python
              tag: 3.14-slim
            command:
              - sh
            args:
              - -c
              - |
                cp /config/server.py /tmp/server.py && \
                chmod +x /tmp/server.py && \
                python3 /tmp/server.py --port 8080 --data-dir /var/lib/p2pool/api --wallet "$(P2POOL_WALLET_ADDRESS)" --nano-p2pool
            env:
              - name: P2POOL_WALLET_ADDRESS
                valueFrom:
                  secretKeyRef:
                    name: p2pool-wallet
                    key: address
            ports:
              - name: dashboard-api
                containerPort: 8080
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 10m
                memory: 64Mi
              limits:
                cpu: 100m
                memory: 256Mi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 101
        runAsGroup: 101
        fsGroup: 101
        fsGroupChangePolicy: OnRootMismatch
    service:
      dashboard:
        type: ClusterIP
        ports:
          web:
            port: 80
            targetPort: web
    persistence:
      shared-api-data:
        existingClaim: p2pool-shared-api-data
        globalMounts:
          - path: /var/lib/p2pool/api
      dashboard-html:
        type: configMap
        name: "dashboard"
        globalMounts:
          - path: /usr/share/nginx/html/index.html
            subPath: dashboard.html
          - path: /usr/share/nginx/html/dashboard.css
            subPath: dashboard.css
          - path: /usr/share/nginx/html/dashboard.js
            subPath: dashboard.js
          - path: /usr/share/nginx/html/favicon.png
            subPath: favicon.png
      dashboard-server-script:
        type: configMap
        name: "dashboard-server-script"
        globalMounts:
          - path: /config/server.py
            subPath: server.py
            readOnly: true
      nginx-config:
        type: configMap
        name: "dashboard-nginx-config"
        globalMounts:
          - path: /etc/nginx/nginx.conf
            subPath: nginx.conf
