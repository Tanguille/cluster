---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: xmrig-scaling
  labels:
    prometheus: kube-prometheus-stack
    role: alert-rules
spec:
  groups:
    - name: xmrig.rules
      interval: 30s
      rules:
        # Alert when xmrig scales up (replicas increased)
        - alert: XmrigScaledUp
          expr: |
            kube_deployment_status_replicas{deployment="xmrig",namespace="web3"}
            and
            (kube_deployment_status_replicas{deployment="xmrig",namespace="web3"} -
             kube_deployment_status_replicas{deployment="xmrig",namespace="web3"} offset 2m) > 0
          for: 1s # Fire almost immediately on change
          annotations:
            summary: "xmrig deployment scaled up"
            description: |
              xmrig deployment scaled up.
              Current replicas: {{ $value }}
              This indicates excess solar power is available for mining.
          labels:
            severity: info
            component: autoscaling

        # Alert when xmrig scales down (replicas decreased)
        - alert: XmrigScaledDown
          expr: |
            kube_deployment_status_replicas{deployment="xmrig",namespace="web3"}
            and
            (kube_deployment_status_replicas{deployment="xmrig",namespace="web3"} -
             kube_deployment_status_replicas{deployment="xmrig",namespace="web3"} offset 2m) < 0
          for: 1s # Fire almost immediately on change
          annotations:
            summary: "xmrig deployment scaled down"
            description: |
              xmrig deployment scaled down.
              Current replicas: {{ $value }}
              This indicates insufficient solar power for mining.
          labels:
            severity: info
            component: autoscaling


